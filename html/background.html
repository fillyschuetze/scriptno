<html>
<head>
<meta http-equiv="Content-Script-Type" content="text/javascript, charset=UTF-8">
<script type="text/javascript" src="../js/yoyo.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script type="text/javascript">
// Credits and ideas: NotScripts, AdBlock Plus for Chrome, Ghostery, KB SSL Enforcer
var version = (function () {
	var xhr = new XMLHttpRequest();
	xhr.open('GET', chrome.extension.getURL('manifest.json'), false);
	xhr.send(null);
	return JSON.parse(xhr.responseText).version;
}());
var popup = [];
var icontype;
var changed = false;
const ITEMS = {};
/*
var searches = new Array();
searches['google'] = ["Google SSL","https://encrypted.google.com/search?q="];
searches['duckduckgo'] = ["DuckDuckGo SSL","https://duckduckgo.com/?kh=1&kl=wt-wt&kp=-1&k1=-1&ke=-1&ko=s&q="];
searches['scroogle'] = ["Scroogle SSL","https://ssl.scroogle.org/cgi-bin/nbbwssl.cgi?Gw="];
function initSearch() {
	chrome.omnibox.setDefaultSuggestion({description: searches[localStorage['search']][0]+': %s'});
	chrome.omnibox.onInputChanged.removeListener(searchList); // prevent bubbling
	chrome.omnibox.onInputChanged.addListener(searchList);
	chrome.omnibox.onInputEntered.removeListener(searchGen); // prevent bubbling
	chrome.omnibox.onInputEntered.addListener(searchGen);
}
function searchList(text, suggest) {
	// I know, I know: below is a little hideous and violates K.I.S.S.; an array + the .splice function would have worked well, but the text variable makes things awkward
	if (localStorage['search'] == 'google') {
		suggest([
			{content: searches['duckduckgo'][1]+text, description: searches['duckduckgo'][0]+': '+text},
			{content: searches['scroogle'][1]+text, description: searches['scroogle'][0]+': '+text}
		]);
	} else if (localStorage['search'] == 'duckduckgo') {
		suggest([
			{content: searches['google'][1]+text, description: searches['google'][0]+': '+text},
			{content: searches['scroogle'][1]+text, description: searches['scroogle'][0]+': '+text}
		]);
	} else if (localStorage['search'] == 'scroogle') {
		suggest([
			{content: searches['google'][1]+text, description: searches['google'][0]+': '+text},
			{content: searches['duckduckgo'][1]+text, description: searches['duckduckgo'][0]+': '+text}
		]);
	}
}
function searchGen(text) {
	if (text.substr(0,8) != 'https://') text = searches[localStorage['search']][1]+text;
	chrome.tabs.create({ url: text, selected: true });
}
*/
function enabled(url) {
	if (localStorage["enable"] == "true" && domainCheck(url) != '0' && (domainCheck(url) == '1' || (localStorage["mode"] == "block" && domainCheck(url)) == '-1')) return 'true';
	return 'false';
}
function domainCheck(domain, req) {
	if (req === undefined) {
		if ((localStorage['annoyances'] == 'true' && localStorage['annoyancesmode'] == 'strict' && baddies(domain, localStorage['annoyancesmode'], localStorage['antisocial']) == '1') || (localStorage['antisocial'] == 'true' && baddies(domain, localStorage['annoyancesmode'], localStorage['antisocial']) == '2')) return '1';
	}
	domainname = extractDomainFromURL(domain.toLowerCase());
	var blackList = JSON.parse(localStorage['blackList']);
	var whiteList = JSON.parse(localStorage['whiteList']);
	var blackListSession = JSON.parse(sessionStorage['blackList']);
	var whiteListSession = JSON.parse(sessionStorage['whiteList']);
	if (domainname.substr(0,4) == 'www.') {
		if (localStorage['mode'] == 'block' && in_array(domainname.substr(4), whiteListSession)) return '0';
		if (localStorage['mode'] == 'allow' && in_array(domainname.substr(4), blackListSession)) return '1';
		if (in_array(domainname.substr(4), whiteList)) return '0';
		if (in_array(domainname.substr(4), blackList)) return '1';
	} else {
		if (localStorage['mode'] == 'block' && in_array(domainname, whiteListSession)) return '0';
		if (localStorage['mode'] == 'allow' && in_array(domainname, blackListSession)) return '1';
		if (in_array(domainname, whiteList)) return '0';
		if (in_array(domainname, blackList)) return '1';
	}
	if (req === undefined) {
		if (localStorage['annoyances'] == 'true' && localStorage['annoyancesmode'] == 'relaxed' && baddies(domain, localStorage['annoyancesmode'], localStorage['antisocial']) == '1') return '1';
	}
	return '-1';
}
function domainSort(hosts) {
	sorted_hosts = new Array();
	split_hosts = new Array();
	multi = false;
	if (hosts.length > 0) {
		if (hosts[0].length == 2) multi = true;
		if (multi) {
			nodeinfo = new Array();
			for (h in hosts) {
				split_hosts.push([getDomain(extractDomainFromURL(hosts[h][0])), hosts[h][0], hosts[h][1]]);
			}
			split_hosts.sort();
			for (h in split_hosts) {
				sorted_hosts.push([split_hosts[h][1], split_hosts[h][2]]);
			}
		} else {
			for (h in hosts) {
				split_hosts.push([getDomain(extractDomainFromURL(hosts[h])), hosts[h]]);
			}
			split_hosts.sort();
			for (h in split_hosts) {
				sorted_hosts.push(split_hosts[h][1]);
			}
		}
		return sorted_hosts;
	}
	return hosts;
}
function trustCheck(domain) {
	var blackList = JSON.parse(localStorage['blackList']);
	var whiteList = JSON.parse(localStorage['whiteList']);
	if (in_array(domain.toLowerCase(), whiteList) == 2 || in_array(domain.toLowerCase(), blackList) == 2) return true;
	return false;
}
function allowTopHandler(domain) {
	if (domain) {
		domainHandler(domain, 2);
		if (!domain.match(/^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})$/g)) domain = '*.'+getDomain(domain);
		domainHandler(domain, 0);
		return true;
	}
	return false;
}
function domainHandler(domain,action,listtype) {
	if (listtype === undefined)
		listtype = 0;
	if (domain) {
		errorflag = false;
		domain = domain.toLowerCase();
		action = parseInt(action);
		// Initialize local storage
		if (listtype == 0) {
			if (typeof(localStorage['whiteList'])=='undefined') localStorage['whiteList'] = JSON.stringify([]);
			if (typeof(localStorage['blackList'])=='undefined') localStorage['blackList'] = JSON.stringify([]);
			var whiteList = JSON.parse(localStorage['whiteList']);
			var blackList = JSON.parse(localStorage['blackList']);
		} else if (listtype == 1) {
			if (typeof(sessionStorage['whiteList'])=='undefined') sessionStorage['whiteList'] = JSON.stringify([]);
			if (typeof(sessionStorage['blackList'])=='undefined') sessionStorage['blackList'] = JSON.stringify([]);
			var whiteList = JSON.parse(sessionStorage['whiteList']);
			var blackList = JSON.parse(sessionStorage['blackList']);
		}
		// Remove domain from whitelist and blacklist
		var pos = whiteList.indexOf(domain);
		if (pos>-1) whiteList.splice(pos,1);
		pos = blackList.indexOf(domain);
		if (pos>-1) blackList.splice(pos,1);
		
		pos = whiteList.indexOf('*.'+getDomain(domain));
		if (pos>-1) whiteList.splice(pos,1);
		pos = blackList.indexOf('*.'+getDomain(domain));
		if (pos>-1) blackList.splice(pos,1);
		
		if (domain.substr(0,4)=='www.') {
			var pos = whiteList.indexOf(domain.substr(4));
			if (pos>-1) whiteList.splice(pos,1);
			pos = blackList.indexOf(domain.substr(4));
			if (pos>-1) blackList.splice(pos,1);
			domain = domain.substr(4);
		}
		if (domain.substr(0,2)=='*.' && action != '2') {
			var pos = whiteList.indexOf(domain.substr(2));
			if (pos>-1) whiteList.splice(pos,1);
			pos = blackList.indexOf(domain.substr(2));
			if (pos>-1) blackList.splice(pos,1);
		}
		switch(action) {
			case 0:	// Whitelist
				if (in_array(domain, whiteList) != 2) whiteList.push(domain);
				else errorflag = true;
				break;
			case 1:	// Blacklist
				if (in_array(domain, blackList) != 2) blackList.push(domain);
				else errorflag = true;
				break;
			case 2:	// Remove
				break;
		}
		if (errorflag) return false;
		if (listtype == 0) {
			localStorage['whiteList'] = JSON.stringify(whiteList);
			localStorage['blackList'] = JSON.stringify(blackList);
		} else if (listtype == 1) {
			sessionStorage['whiteList'] = JSON.stringify(whiteList);
			sessionStorage['blackList'] = JSON.stringify(blackList);
		}
		return true;
	}
	return false;
}
function optionExists(opt) {
	return (typeof localStorage[opt] != "undefined");
}
function defaultOptionValue(opt, val) {
	if (!optionExists(opt)) localStorage[opt] = val;
}
function setDefaultOptions() {
	defaultOptionValue("version", version);
	defaultOptionValue("enable", "true");
	defaultOptionValue("mode", "block");
	defaultOptionValue("refresh", "true");
	defaultOptionValue("script", "true");
	defaultOptionValue("noscript", "true");
	defaultOptionValue("object", "true");
	defaultOptionValue("applet", "true");
	defaultOptionValue("embed", "true");
	defaultOptionValue("iframe", "true");
	defaultOptionValue("frame", "true");
	defaultOptionValue("audio", "true");
	defaultOptionValue("video", "true");
	defaultOptionValue("image", "false");
	defaultOptionValue("annoyances", "true");
	defaultOptionValue("annoyancesmode", "relaxed");
	defaultOptionValue("antisocial", "false");
	defaultOptionValue("preservesamedomain", "false");
	defaultOptionValue("webbugs", "true");
	defaultOptionValue("classicoptions", "false");
	defaultOptionValue("rating", "true");
	defaultOptionValue("referrer", "true");
	defaultOptionValue("linktarget", "off");
	defaultOptionValue("search", "duckduckgo");
	defaultOptionValue("domainsort", "true");
	if (!optionExists("blackList")) localStorage['blackList'] = JSON.stringify([]);
	if (!optionExists("whiteList")) localStorage['whiteList'] = JSON.stringify(["translate.googleapis.com","talkgadget.google.com"]);
	if (typeof sessionStorage['blackList'] === "undefined") sessionStorage['blackList'] = JSON.stringify([]);
	if (typeof sessionStorage['whiteList'] === "undefined") sessionStorage['whiteList'] = JSON.stringify([]);
	if (optionExists("removethirdparty")) // old setting (pre-v1.0.0.0)
		delete localStorage["removethirdparty"];
	chrome.browserAction.setBadgeBackgroundColor({color:[208, 0, 24, 255]});
}
function updateCount(tabId) {
	const TAB_ITEMS = ITEMS[tabId] || (ITEMS[tabId] = [0]);
	const TAB_BLOCKED_COUNT = ++TAB_ITEMS[0];
	chrome.browserAction.setBadgeBackgroundColor({ color: [208, 0, 24, 255], tabId: tabId });
	chrome.browserAction.setBadgeText({tabId: tabId, text: TAB_BLOCKED_COUNT + ''});
}
function removeFromArray(arr, value) {
	for (var i = arr.length-1; i >= 0; i--) {
		if (arr[i][0] == value)
			arr.splice(i,1);
	}
}
function removeHash(str) {
	if (str.indexOf("#") != -1) return str.substr(0, str.indexOf("#"));
	return str;
}
function resetTabData(id, url) {
	if (id && url) {
		ITEMS[id] = [0];
		ITEMS[id]['url'] = url;
		ITEMS[id]['blocked'] = [];
		ITEMS[id]['allowed'] = [];
	}
}
function revokeTemp() {
	sessionStorage['blackList'] = JSON.stringify([]);
	sessionStorage['whiteList'] = JSON.stringify([]);
}
function statuschanger() {
	if (localStorage['enable'] == 'true') {
		localStorage['enable'] = 'false';
		chrome.browserAction.setIcon({path: "../img/IconDisabled.png"});
	} else {
		localStorage['enable'] = 'true';
		chrome.browserAction.setIcon({path: "../img/Forbidden.png"});
	}
}
chrome.tabs.onRemoved.addListener(function(tabid) {
	delete ITEMS[tabid];
});
chrome.tabs.onUpdated.addListener(function(tabid, changeinfo, tab) {
	if (localStorage['enable'] == 'true' && tab.url.toLowerCase().substr(0,4) == 'http') {
		if (changeinfo.status == 'loading') {
			icontype = "Allowed";
			if (enabled(tab.url) == "true")
				icontype = "Forbidden";
			if (in_array(extractDomainFromURL(tab.url.toLowerCase()), JSON.parse(sessionStorage["whiteList"])) || (extractDomainFromURL(tab.url).toLowerCase().substr(0,4) == 'www.' && in_array(extractDomainFromURL(tab.url.toLowerCase()).substr(4), JSON.parse(sessionStorage["whiteList"]))) || in_array(extractDomainFromURL(tab.url.toLowerCase()), JSON.parse(sessionStorage["blackList"])) || (extractDomainFromURL(tab.url).toLowerCase().substr(0,4) == 'www.' && in_array(extractDomainFromURL(tab.url.toLowerCase()).substr(4), JSON.parse(sessionStorage["blackList"]))))
				icontype = "Temp";
			chrome.browserAction.setIcon({path: "../img/Icon"+icontype+".png", tabId: tabid});
		} else if (changeinfo.status == "complete") {
			if (typeof ITEMS[tabid] !== 'undefined') {
				chrome.tabs.executeScript(tabid, {code: 'loaded()', allFrames: true});
				changed = true;
				if (localStorage['mode'] == 'block' && typeof ITEMS[tabid]['allowed'] !== 'undefined') {
					for (i=0; i<ITEMS[tabid]['allowed'].length; i++) {
						if (in_array(extractDomainFromURL(relativeToAbsoluteUrl(ITEMS[tabid]['allowed'][i][0]).toLowerCase()), JSON.parse(sessionStorage["whiteList"])) || (extractDomainFromURL(relativeToAbsoluteUrl(ITEMS[tabid]['allowed'][i][0]).toLowerCase()).substr(0,4) == 'www.' && in_array(extractDomainFromURL(relativeToAbsoluteUrl(ITEMS[tabid]['allowed'][i][0]).toLowerCase()).substr(4), JSON.parse(sessionStorage["whiteList"]))))
							chrome.browserAction.setIcon({path: "../img/IconTemp.png", tabId: tabid});
					}
				} else if (localStorage['mode'] == 'allow' && typeof ITEMS[tabid]['blocked'] !== 'undefined') {
					for (i=0; i<ITEMS[tabid]['blocked'].length; i++) {
						if (in_array(extractDomainFromURL(relativeToAbsoluteUrl(ITEMS[tabid]['blocked'][i][0]).toLowerCase()), JSON.parse(sessionStorage["blackList"])) || (extractDomainFromURL(relativeToAbsoluteUrl(ITEMS[tabid]['blocked'][i][0]).toLowerCase()).substr(0,4) == 'www.' && in_array(extractDomainFromURL(relativeToAbsoluteUrl(ITEMS[tabid]['blocked'][i][0]).toLowerCase()).substr(4), JSON.parse(sessionStorage["blackList"]))))
							chrome.browserAction.setIcon({path: "../img/IconTemp.png", tabId: tabid});
					}
				}
			}
		}
	} else chrome.browserAction.setIcon({path: "../img/IconDisabled.png", tabId: tabid});
});
chrome.extension.onConnect.addListener(function(port) {
	port.onMessage.addListener(function(msg) {
		if (port.name == 'popuplifeline') {
			if (msg.url && msg.tid) {
				popup=[msg.url, msg.tid];
			}
		}
	});
	port.onDisconnect.addListener(function(msg) {
		if (popup.length > 0) {
			if (localStorage['refresh'] == 'true') chrome.tabs.update(popup[1], {url: popup[0]});
			popup=[];
		}
	});
});
chrome.extension.onRequest.addListener(function(request, sender, sendResponse) {
	if (request.reqtype == 'get-settings') {
		sendResponse({status: localStorage['enable'], enable: enabled(sender.tab.url), mode: localStorage['mode'], annoyancesmode: localStorage['annoyancesmode'], antisocial: localStorage['antisocial'], whitelist: localStorage['whiteList'], blacklist: localStorage['blackList'], whitelistSession: sessionStorage['whiteList'], blackListSession: sessionStorage['blackList'], script: localStorage['script'], noscript: localStorage['noscript'], object: localStorage['object'], applet: localStorage['applet'], embed: localStorage['embed'], iframe: localStorage['iframe'], frame: localStorage['frame'], audio: localStorage['audio'], video: localStorage['video'], image: localStorage['image'], annoyances: localStorage['annoyances'], preservesamedomain: localStorage['preservesamedomain'], webbugs: localStorage['webbugs'], referrer: localStorage['referrer'], linktarget: localStorage['linktarget']});
		if (typeof ITEMS[sender.tab.id] === 'undefined') {
			resetTabData(sender.tab.id, sender.tab.url);
		} else {
			if ((request.iframe != '1' && ((ITEMS[sender.tab.id]['url'].toLowerCase() != sender.tab.url.toLowerCase() && (sender.tab.url.indexOf("#") != -1 || ITEMS[sender.tab.id]['url'].indexOf("#") != -1) && removeHash(sender.tab.url.toLowerCase()) != removeHash(ITEMS[sender.tab.id]['url'].toLowerCase())) || (sender.tab.url.indexOf("#") == -1 && ITEMS[sender.tab.id]['url'].indexOf("#") == -1 && sender.tab.url.toLowerCase() != ITEMS[sender.tab.id]['url'].toLowerCase()) || changed) || sender.tab.url.toLowerCase().indexOf('https://chrome.google.com/webstore') != -1)) {
				resetTabData(sender.tab.id, sender.tab.url);
			}
		}
	} else if (request.reqtype == 'get-list') {
		enableval = domainCheck(request.url);
		if (trustCheck(extractDomainFromURL(request.url))) enableval = 3;
		if (localStorage['mode'] == 'block') sessionlist = sessionStorage['whiteList'];
		else if (localStorage['mode'] == 'allow') sessionlist = sessionStorage['blackList'];
		sendResponse({status: localStorage['enable'], enable: enableval, mode: localStorage['mode'], annoyancesmode: localStorage['annoyancesmode'], antisocial: localStorage['antisocial'], annoyances: localStorage['annoyances'], closepage: localStorage['classicoptions'], rating: localStorage['rating'], temp: sessionlist, blockeditems: ITEMS[request.tid]['blocked'], alloweditems: ITEMS[request.tid]['allowed'], domainsort: localStorage['domainsort']});
		changed = true;
	} else if (request.reqtype == 'update-blocked') {
		updateCount(sender.tab.id);
		if (request.src) {
			if (typeof ITEMS[sender.tab.id]['blocked'] === 'undefined') ITEMS[sender.tab.id]['blocked'] = [];
			ITEMS[sender.tab.id]['blocked'].push([request.src, request.node]);
		}
	} else if (request.reqtype == 'update-allowed') {
		if (request.src) {
			if (typeof ITEMS[sender.tab.id]['allowed'] === 'undefined') ITEMS[sender.tab.id]['allowed'] = [];
			ITEMS[sender.tab.id]['allowed'].push([request.src, request.node]);
		}
	} else if (request.reqtype == 'save') {
		domainHandler(request.url, 2, 1);
		domainHandler(request.url, request.list);
		changed = true;
	} else if (request.reqtype == 'temp') {
		if (typeof request.url == 'object') {
			for (i=0;i<request.url.length;i++) {
				if (request.url[i][0] != 'no.script' && request.url[i][0] != 'web.bug') {
					requesturl = request.url[i][0];
					if ((localStorage['annoyances'] == 'true' && (localStorage['annoyancesmode'] == 'strict' || (localStorage['annoyancesmode'] == 'relaxed' && domainCheck(requesturl, 1) != '0')) && baddies(requesturl, localStorage['annoyancesmode'], localStorage['antisocial']) == 1) || (localStorage['antisocial'] == 'true' && baddies(requesturl, localStorage['annoyancesmode'], localStorage['antisocial']) == '2')) {
						// do nothing
					} else {
						requesttype = request.url[i][1];
						if (requesttype == '3') {
							requesttype = 0;
							if (!requesturl.match(/^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})$/g)) requesturl = '*.'+getDomain(requesturl);
						}
						if (request.mode == 'block') domainHandler(requesturl, 0, 1);
						else domainHandler(requesturl, 1, 1);
					}
				}
			}
		} else {
			requesturl = request.url;
			if ((localStorage['annoyances'] == 'true' && (localStorage['annoyancesmode'] == 'strict' || (localStorage['annoyancesmode'] == 'relaxed' && domainCheck(requesturl, 1) != '0')) && baddies(requesturl, localStorage['annoyancesmode'], localStorage['antisocial']) == 1) || (localStorage['antisocial'] == 'true' && baddies(requesturl, localStorage['annoyancesmode'], localStorage['antisocial']) == '2')) {
				// do nothing
			} else {
				requesttype = request.oldlist;
				if (requesttype == '3') {
					requesttype = 0;
					if (!requesturl.match(/^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})$/g)) requesturl = '*.'+getDomain(requesturl);
				}
				if (request.mode == 'block') domainHandler(requesturl, 0, 1);
				else domainHandler(requesturl, 1, 1);
			}
		}
		changed = true;
	} else if (request.reqtype == 'remove-temp') {
		if (typeof request.url == 'object') {
			for (i=0;i<request.url.length;i++) {
				requesturl = request.url[i][0];
				requesttype = request.url[i][1];
				if (requesttype == '3') {
					requesttype = 0;
					if (!requesturl.match(/^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})$/g)) requesturl = '*.'+getDomain(requesturl);
				}
				domainHandler(requesturl, 2, 1);
			}
		} else {
			requesturl = request.url;
			requesttype = request.oldlist;
			if (requesttype == '3') {
				requesttype = 0;
				if (!requesturl.match(/^((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){3}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})$/g)) requesturl = '*.'+getDomain(requesturl);
			}
			domainHandler(requesturl, 2, 1);
		}
		changed = true;
	} else if (request.reqtype == 'refresh-page-icon') {
		if (request.type == '0') chrome.browserAction.setIcon({path: "../img/IconAllowed.png", tabId: request.tid});
		else if (request.type == '1') chrome.browserAction.setIcon({path: "../img/IconForbidden.png", tabId: request.tid});
		else if (request.type == '2') chrome.browserAction.setIcon({path: "../img/IconTemp.png", tabId: request.tid});
	} else
		sendResponse({});
});

setDefaultOptions();
//initSearch();

if (!optionExists("version") || localStorage["version"] != version) {
	//chrome.tabs.create({ url: chrome.extension.getURL('updated.html'), selected: false });
	localStorage["version"] = version;
}
</script>
</head>
</html>